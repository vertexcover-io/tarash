name: Add Fal Model

on:
  issues:
    types: [labeled]

jobs:
  add-fal-model:
    if: github.event.label.name == 'add-fal-provider'
    runs-on: ubuntu-latest
    timeout-minutes: 30
    permissions:
      contents: write
      pull-requests: write
      issues: write
      id-token: write

    steps:
      - name: Check sender permission
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          PERM=$(gh api repos/${{ github.repository }}/collaborators/${{ github.event.sender.login }}/permission --jq '.permission')
          echo "Sender '${{ github.event.sender.login }}' has permission: $PERM"
          if [[ "$PERM" != "admin" && "$PERM" != "maintain" ]]; then
            echo "❌ Insufficient permission. Only admin/maintain can trigger this workflow."
            exit 1
          fi

      - name: Checkout
        uses: actions/checkout@v4

      - name: Install uv
        uses: astral-sh/setup-uv@v5

      - uses: anthropics/claude-code-action@v1
        env:
          FAL_KEY: ${{ secrets.FAL_KEY }}
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          branch_prefix: "feat/add-fal-"
          base_branch: "master"
          prompt: |
            Extract the fal.ai model ID from this issue and add it to tarash-gateway.

            Issue title: ${{ github.event.issue.title }}
            Issue body:
            ${{ github.event.issue.body }}

            The model ID is specified as "Model ID: `fal-ai/...`" in the body,
            or as "Add fal model: fal-ai/..." in the title.

            Once you have the model ID, run: /add-fal-model <model-id>
          show_full_output: true
          claude_args: "--allowedTools Bash,Read,Write,Edit,Glob,Grep,WebFetch"

      - name: Create branch and PR
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Check if there are any changes
          if git diff --quiet && git diff --cached --quiet; then
            echo "No changes detected, skipping PR creation"
            exit 0
          fi

          # Extract model ID from issue title for branch name
          MODEL_SLUG=$(echo "${{ github.event.issue.title }}" | sed 's/Add fal model: //i' | sed 's/[^a-zA-Z0-9]/-/g' | tr '[:upper:]' '[:lower:]')
          BRANCH="feat/add-fal-${MODEL_SLUG}"

          # Configure git
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

          # Create branch, commit, and push
          git checkout -b "$BRANCH"
          git add -A
          git commit -m "✨ Add fal model: ${MODEL_SLUG}"
          git push origin "$BRANCH"

          # Create PR linking to the issue
          gh pr create \
            --title "✨ Add fal model: ${MODEL_SLUG}" \
            --body "$(cat <<EOF
          ## Summary

          Automated implementation triggered by #${{ github.event.issue.number }}.

          Adds support for the \`${MODEL_SLUG}\` model to the Fal provider in tarash-gateway.

          Closes #${{ github.event.issue.number }}
          EOF
          )" \
            --base master \
            --head "$BRANCH"
